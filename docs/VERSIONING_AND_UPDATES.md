# Extension Versioning and Updates

This document explains how LibreOffice extension versioning and automatic updates work, and how to use these features with Calc-DNA.

## How LibreOffice Handles Extension Versions

### Extension Identification

Each extension is uniquely identified by its **identifier** specified in `description.xml`:

```xml
<identifier value="org.calcdna.myextension" />
```

**Key Rules:**
- Two extensions with the **same identifier** cannot be installed simultaneously
- When installing an extension with an existing identifier, LibreOffice treats it as an **upgrade**
- Extensions without explicit identifiers get an auto-generated identifier (`org.openoffice.legacy.*`)

### Version Comparison

LibreOffice compares version strings to determine if an extension is newer:

```xml
<version value="1.2.5" />
```

**Version Behavior:**
- When installing: LibreOffice checks if a newer/older version is already installed
- Newer version → Offers to upgrade the existing extension
- Older version → Warns about downgrading
- Same version → Asks to reinstall/replace

**Supported Version Formats:**
- Semantic versioning: `1.0.0`, `2.1.3`, `1.0.0-beta`
- Simple numbering: `1.0`, `2.5`
- Date-based: `2026.01.29`

## Automatic Update Checking

LibreOffice can automatically check for extension updates if you provide an **update URL** in `description.xml`.

### How It Works

1. User clicks "Check for Updates" in Extension Manager (Tools → Extension Manager → Check for Updates)
2. LibreOffice downloads the update XML file from the URL you specified
3. Compares the version in the update XML with the installed version
4. If a newer version is available, prompts the user to download and install it

### Configuration

#### In description.xml (generated by Calc-DNA CLI)

```xml
<update-information>
  <src xlink:href="https://example.com/updates/MyExtension.update.xml" />
</update-information>
```

#### The update.xml File (you host this)

You need to host an `update.xml` file at the URL specified above. This file contains information about the latest version:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<description xmlns="http://openoffice.org/extensions/update/2006"
             xmlns:xlink="http://www.w3.org/1999/xlink">

  <identifier value="org.calcdna.myextension" />
  <version value="1.2.0" />

  <update-download>
    <src xlink:href="https://example.com/downloads/MyExtension-1.2.0.oxt" />
  </update-download>

  <release-notes>
    <src xlink:href="https://example.com/releases/v1.2.0.html" lang="en" />
  </release-notes>

</description>
```

See [update.xml.example](update.xml.example) for a complete example.

## Using Versioning with Calc-DNA

### Basic Package Creation

Create an extension with version information:

```bash
dotnet run --project src/CalcDNA.CLI -- \
  MyAddIn.dll \
  --package \
  --version "1.0.0" \
  --publisher "Your Name" \
  --description "My awesome Calc add-in"
```

This generates an `.oxt` file with:
- Identifier: `org.calcdna.myaddin`
- Version: `1.0.0`

### Creating an Update

To release version 1.1.0:

1. **Increment the version number:**

```bash
dotnet run --project src/CalcDNA.CLI -- \
  MyAddIn.dll \
  --package \
  --version "1.1.0" \
  --publisher "Your Name" \
  --description "My awesome Calc add-in"
```

2. **Distribute the new `.oxt` file**

When users install `MyAddIn-1.1.0.oxt`, LibreOffice will:
- Recognize it as an update to the existing `MyAddIn-1.0.0`
- Prompt to upgrade
- Replace the old version with the new one

### Enabling Automatic Updates

To enable automatic update checking, provide an update URL:

```bash
dotnet run --project src/CalcDNA.CLI -- \
  MyAddIn.dll \
  --package \
  --version "1.0.0" \
  --update-url "https://example.com/updates/MyAddIn.update.xml" \
  --release-notes-url "https://example.com/releases/v1.0.0.html"
```

#### Setting Up Update Hosting

1. **Host your `.oxt` files** at a public URL (e.g., GitHub Releases, your website)

2. **Create and host an `update.xml` file** that points to the latest version:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<description xmlns="http://openoffice.org/extensions/update/2006"
             xmlns:xlink="http://www.w3.org/1999/xlink">
  <identifier value="org.calcdna.myaddin" />
  <version value="1.1.0" />
  <update-download>
    <src xlink:href="https://example.com/MyAddIn-1.1.0.oxt" />
  </update-download>
</description>
```

3. **When releasing a new version**, update the `update.xml` file with the new version number and download URL

4. Users can now check for updates via Extension Manager

## Update Workflow Example

### Initial Release (v1.0.0)

```bash
# Create version 1.0.0
dotnet run --project src/CalcDNA.CLI -- MyAddIn.dll --package \
  --version "1.0.0" \
  --update-url "https://mysite.com/updates/MyAddIn.update.xml"

# Host MyAddIn-1.0.0.oxt at https://mysite.com/downloads/
# Create update.xml with version 1.0.0
# Host update.xml at https://mysite.com/updates/MyAddIn.update.xml
```

### Bug Fix Release (v1.0.1)

```bash
# Fix bugs in your code
# Create version 1.0.1
dotnet run --project src/CalcDNA.CLI -- MyAddIn.dll --package \
  --version "1.0.1" \
  --update-url "https://mysite.com/updates/MyAddIn.update.xml"

# Host MyAddIn-1.0.1.oxt at https://mysite.com/downloads/
# Update update.xml:
#   <version value="1.0.1" />
#   <update-download>
#     <src xlink:href="https://mysite.com/downloads/MyAddIn-1.0.1.oxt" />
#   </update-download>
```

### New Feature Release (v1.1.0)

```bash
# Add new features
# Create version 1.1.0
dotnet run --project src/CalcDNA.CLI -- MyAddIn.dll --package \
  --version "1.1.0" \
  --update-url "https://mysite.com/updates/MyAddIn.update.xml" \
  --release-notes-url "https://mysite.com/releases/v1.1.0.html"

# Host MyAddIn-1.1.0.oxt
# Update update.xml with version 1.1.0 and new download link
```

## CLI Options for Versioning

```
--version <version>
    Extension version (e.g., 1.0.0, 2.1.5-beta)
    Default: 1.0.0

--update-url <url>
    URL to update.xml file for automatic update checking
    Example: https://example.com/updates/Extension.update.xml

--release-notes-url <url>
    URL to release notes for this version
    Example: https://example.com/releases/v1.0.0.html

--publisher <name>
    Publisher name (appears in Extension Manager)

--min-lo-version <version>
    Minimum LibreOffice version required
    Default: 7.0
```

## Best Practices

### Version Numbering

1. **Use Semantic Versioning:** `MAJOR.MINOR.PATCH`
   - MAJOR: Breaking changes
   - MINOR: New features (backward compatible)
   - PATCH: Bug fixes

2. **Be Consistent:** Once you choose a format, stick with it

3. **Don't Reuse Version Numbers:** Each release should have a unique version

### Update Distribution

1. **Test Updates:** Install your previous version, then test the update process

2. **Backup Compatibility:** Try to maintain backward compatibility when possible

3. **Document Changes:** Provide clear release notes for each version

4. **Use HTTPS:** Always use HTTPS URLs for update.xml and downloads

5. **Update XML Caching:** LibreOffice may cache update.xml, updates might not appear immediately

### Identifier Management

1. **Choose Carefully:** Your identifier should be globally unique
2. **Use Reverse Domain:** `org.yoursite.extensionname` or `com.company.product`
3. **Never Change It:** Changing the identifier creates a completely different extension
4. **Keep It Simple:** Use lowercase letters, numbers, and dots only

## Troubleshooting

### Users Not Seeing Updates

- Verify `update.xml` is accessible at the specified URL
- Check XML format is correct
- Clear LibreOffice cache: Close LibreOffice completely and restart
- Check LibreOffice's online update settings (Tools → Options → LibreOffice → Online Update)

### Version Not Recognized as Upgrade

- Verify the identifier in both versions is **exactly the same**
- Check version numbering is correct and incrementing
- Ensure `description.xml` is properly formatted

### Update Download Fails

- Verify the download URL in `update.xml` is correct and accessible
- Ensure the `.oxt` file is available at the specified location
- Check for HTTPS certificate issues

## References

- [LibreOffice Developer's Guide: Extensions](https://wiki.documentfoundation.org/Documentation/DevGuide/Extensions)
- [Extension Manager Help](https://help.libreoffice.org/latest/en-US/text/shared/01/packagemanager.html)
- [Apache OpenOffice Extensions Guide](https://wiki.openoffice.org/wiki/Extensions_Packager)
